const mysql = require('mysql');
const qs = require('qs');
const axios = require('axios');
const axios1 = require('axios');

const pool = mysql.createPool({
  connectionLimit : 10,
  host     : 'soapboxinternal.riversilica.com',
  user     : 'pixfixlocal',
  password : 'Pixfix@123',
  database : 'pixfix_test'
});

// var job_name;
// var job_url;

exports.handler = (event, context, callback) => {
  var apiResponse = {};
  var job_iD;
  var job_Name;
  context.callbackWaitsForEmptyEventLoop = false;
  pool.getConnection(function(err, con) {
    if (err) throw err;
    con.query("SELECT * FROM tbl_job_details where status = 'free'", function (err, result, fields) {
    if (err) throw err;
    console.log(result.length);
    if(result.length == 0){
      console.log("no job found");
      apiResponse.status=false;
      apiResponse.message="NO JOB FOUND";
      callback(null, apiResponse);
       
    }

else{
    
   
     job_iD= result[0].jobID;
     job_Name= result[0].jobNAME ;
     
     console.log(job_iD);
     
  con.query("update tbl_job_details set status = 'used', currentUser = 'shashank' where jobID = '"+job_iD+"'" , function (err, result, fields) {
       
  //console.log("update tbl_job_details set status = 'used', currentUser = 'shashank' where jobId = '"+job_iD+"'")
    if (err) throw err;
    
  var url = "http://skycode5.riversilica.com/users";
  const data={};
  data.user_name = "admin";
  data.password = "pixfix@123";
  
  axios.post(url, qs.stringify(data))
    .then((res) => {
      console.log(url);
      console.log(JSON.stringify(res.data));
        
        if(res.data["status"]=="success"){
          var cookieRes=res.headers['set-cookie'];
          var cookieArray=cookieRes.split(";");
          var sessionValArray=cookieArray[0].split("=");
          var phpSessionId=cookieArray[0];
          
          // apiResponse.status=true;
          // apiResponse.messgae="JOB DETAILS";
          // apiResponse.data=cookieArray[0];
          // callback(null, apiResponse);
                      
        }else{
          apiResponse.status=false;
          apiResponse.messgae="Invalid Authorization";
          callback(null, apiResponse);
        }
        
                 let url1 = "http://skycode5.riversilica.com/jobs/job_get/"+job_Name;
                // console.log(url1);
                axios.get(url1, {headers:{"Cookie":phpSessionId}})
               // console.log(phpSessionId)
                .then((res2) =>{ 
                  console.log("entering");
                  //console.log(res2.data.pfmt_job.node_name);
                
                // console.log(res2.data.pfmt_job.job_status);
                var response = res2.data.pfmt_job.job_status;
                var node = res2.data.pfmt_job.node_name;
                
                if(response != "running")
                {
                   let url2 = "http://skycode5.riversilica.com/jobs/job_start/"+job_Name+"?node_name="+node;
                   //console.log(url2)
                    axios.get(url2, {headers:{"Cookie": phpSessionId}})
                    //console.log(phpSessionId)
                    .then((res3) =>{ 
                      console.log("started");
                     
                      
                      //var serverUrl = res2.data.pfmt_job.pfmt_input_group.inputs[0].pfmt_input.streamer[0].pfmt_input_stream.gstaf_src.gstaf_src_rtmp.server_url;
                      var name = res2.data.pfmt_job.job_name;
                      var ID = res2.data.pfmt_job.pfmt_job_id;
                      
                      // console.log(res2.data.pfmt_job.pfmt_input_group.inputs[0].pfmt_input.streamer[0].pfmt_input_stream.gstaf_src.gstaf_src_rtmp.server_url);
                      // console.log(name);
                      // console.log(ID);
                     
                       var apiResponse1 = {};
                     // apiResponse1.Url=serverUrl;
                      apiResponse1.Name=name;
                      apiResponse1.ID = ID;
                      
                      callback(null,apiResponse1);
                    });
                }else {
                  
                  callback(null, "Job is already running");
                }
         
                    
                
}).catch((error)=>{
  apiResponse.status=true;
        apiResponse.messgae="JOB DETAILS";
        apiResponse.data=error;
       
        
      //  callback(apiResponse,null);
});
  con.release();
    
  });
    
});

}
                

});
})
}


